{% extends "base.html" %}
{% block title %}Upload{% endblock %}
{% block head %}
{{ super() }}
<style type="text/css">
    .important { color: #336699; }
</style>
{% endblock %}
{% block content %}
<h1>Upload your click</h1>
<form action="upload" method="POST" enctype="multipart/form-data">
    <p><input type="file" name="click"></p>
    <p><label>Email: <input type="email" name="email"></label></p>
    <p>Devices to test on:</p>
    <ul>
        {% if is_paused %}
            <li>...no test devices are currently online. Please try again later...</li>
        {% else %}
            {% for device in devices %}
                <li><label>{{ device.printable|e }} <input type="checkbox" name="device_{{ device.code|e }}"></label></li>
            {% endfor %}
            {% if not devices %}
                <li>...no test devices are currently online. Please try again later...</li>
            {% endif %}
        {% endif %}
    </ul>
    <p><input type=submit value="Upload"></p>
</form>
<script src="/static/gunzip.min.js"></script>
<script>

function ArFile(file) {
    var self = this;
    this.members = [];

    this.getBytes = function(file, start, length, done) {
        var reader = new FileReader();
        reader.onloadend = function(e) {
            done(null, new Uint8Array(reader.result));
        }
        var slice = file.slice || file.webkitSlice || file.mozSlice;
        reader.readAsArrayBuffer(slice.apply(file, [start, start+length]));
    }
    this.getText = function(file, start, length, done) {
        this.getBytes(file, start, length, function(err, result) {
            if (err) return done(err);
            done(null, String.fromCharCode.apply(null, result));
        });
    }

    this.onload = function(){}

    // parse as ar
    // First, check for magic header !<arch>\n
    this.getText(file, 0, 8, function(err, text) {
        if (err) { self.onload(err); return; }
        if (text !== "!<arch>\n") { self.onload(new Error("Bad global header")); return; }

        // It's an ar file. Read the members
        var filecount = 0;
        function readNextMember(idx) {
            self.getBytes(file, idx, idx + 60, function(err, header) {
                if (err) { self.onload(err); return; }
                self.members.push({
                    filename: String.fromCharCode.apply(null, header.slice(0, 16)).trim(),
                    timestamp: parseInt(String.fromCharCode.apply(null, header.slice(16, 28)).trim(), 10),
                    owner_id: parseInt(String.fromCharCode.apply(null, header.slice(28, 34)).trim(), 10),
                    group_id: parseInt(String.fromCharCode.apply(null, header.slice(34, 40)).trim(), 10),
                    file_mode: String.fromCharCode.apply(null, header.slice(40, 48)).trim(),
                    file_size: parseInt(String.fromCharCode.apply(null, header.slice(48, 58)).trim(), 10),
                    file_magic: String.fromCharCode.apply(null, header.slice(58, 60)).trim()
                });
                idx += 60; // length of header
                self.members[self.members.length-1].offset = idx;
                idx += self.members[self.members.length-1].file_size;
                if (idx % 2 === 1) { idx += 1; }
                if (idx >= file.size) {
                    self.onload();
                } else {
                    filecount += 1;
                    if (filecount > 1000) {
                        self.onload(new Error("Something went wrong parsing the ar file")); return;
                    }
                    readNextMember(idx);
                }
            });
        }
        readNextMember(8);
    });

    this.readByName = function(name, done) {
        var matches = this.members.filter(function(m) { return m.filename === name });
        if (matches.length === 0) { return done(new Error("No such member")); }
        if (matches.length > 1) { return done(new Error("Multiple matching members")); } // shouldn't happen!
        this.getBytes(file, matches[0].offset, matches[0].file_size, done);
    }
}

function TarGzFileFromUint8(uint8) {
    var ungzipped;
    var self = this;
    this.members = [];

    function ungzip(done) {
        var gunzip = new Zlib.Gunzip(uint8);
        ungzipped = gunzip.decompress();
        // now parse the members list

        var filecount = 0;
        function readNextMember(idx) {
            var header = ungzipped.slice(idx, idx+512);
            var metadata = {
                filename: String.fromCharCode.apply(null, header.slice(0, 100)).trim().replace(/\0/g,""),
                file_mode: String.fromCharCode.apply(null, header.slice(100, 108)).trim().replace(/\0/g,""),
                owner_id: String.fromCharCode.apply(null, header.slice(108, 116)).trim().replace(/\0/g,""),
                group_id: String.fromCharCode.apply(null, header.slice(116, 124)).trim().replace(/\0/g,""),
                file_size: parseInt(String.fromCharCode.apply(null, header.slice(124, 136)).trim().replace(/\0/g,""), 8),
                last_modified: String.fromCharCode.apply(null, header.slice(136, 148)).trim().replace(/\0/g,""),
                checksum: String.fromCharCode.apply(null, header.slice(148, 156)).trim().replace(/\0/g,""),
                file_type: String.fromCharCode.apply(null, header.slice(156, 157)).trim().replace(/\0/g,""),
                linked_file_name: String.fromCharCode.apply(null, header.slice(157, 257)).trim().replace(/\0/g,""),
                ustar_indicator: String.fromCharCode.apply(null, header.slice(257, 263)).trim().replace(/\0/g,""),
                ustar_version: String.fromCharCode.apply(null, header.slice(263, 265)).trim().replace(/\0/g,""),
                owner_username: String.fromCharCode.apply(null, header.slice(265, 297)).trim().replace(/\0/g,""),
                owner_groupname: String.fromCharCode.apply(null, header.slice(297, 329)).trim().replace(/\0/g,""),
                device_major_number: String.fromCharCode.apply(null, header.slice(329, 337)).trim().replace(/\0/g,""),
                device_minor_number: String.fromCharCode.apply(null, header.slice(337, 345)).trim().replace(/\0/g,""),
                filename_prefix: String.fromCharCode.apply(null, header.slice(345, 500)).trim().replace(/\0/g,"")
            };
            if (metadata.ustar_indicator !== "ustar") {
                // we are done.
                done(null);
                return;
            }
            self.members.push(metadata);
            idx += 512; // length of header
            self.members[self.members.length-1].offset = idx;
            idx += self.members[self.members.length-1].file_size;
            if (idx % 512 > 0) { idx += 512 - (idx % 512); }
            if (idx >= ungzipped.length) {
                done(null);
            } else {
                filecount += 1;
                if (filecount > 40) {
                    done(new Error("Something went wrong parsing the tar file"));
                    return;
                }
                readNextMember(idx);
            }
        }
        readNextMember(0);

    }

    function readFromUngzipped(name, done) {
        var matches = self.members.filter(function(m) { return m.filename === name; });
        if (matches.length === 0) { return done(new Error("No such filename '"+name+"'")); }
        if (matches.length > 1) { return done(new Error("More than one matching filename")); } // shouldn't happen
        done(null, ungzipped.slice(matches[0].offset, matches[0].offset + matches[0].file_size));
    }

    this.readByName = function(name, done) {
        if (!ungzipped) {
            ungzip(function(err) {
                if (err) { done(err); return; }
                readFromUngzipped(name, done);
            });
        } else {
            readFromUngzipped(name, done);
        }
    }
}

function ClickFile(file) {
    var self = this;
    var loaded = false;
    this.onload = function(){}
    var arfile = new ArFile(file);
    arfile.onload = function(err) {
        loaded = true;
        self.onload(err);
    }

    var cache = {};

    function encache(which, done) {
        if (cache[which]) {
            done();
        } else {
            arfile.readByName(which, function(err, dataAsUint8) {
                if (err) { done(err); return; }
                cache[which] = new TarGzFileFromUint8(dataAsUint8);
                // fetch one file, not caring whether it exists, to populate the members
                cache[which].readByName("./", function() {
                    done();
                })
            });
        }
    }

    this.getFile = function(parent, child, done) {
        if (!loaded) { done(new Error("Click file is not loaded")); return; }
        encache(parent, function(err) {
            if (err) { done(err); return; }
            cache[parent].readByName(child, done);
        });
    }

    this.getFileList = function(parent, done) {
        if (!loaded) { done(new Error("Click file is not loaded")); return; }
        encache(parent, function(err) {
            if (err) { done(err); return; }
            done(null, cache[parent].members);
        });
    }

}

function examine(input, file) {
    var click;
    try {
        click = new ClickFile(file);
    } catch(e) {
        console.error(e); return;
    }
    click.onload = function(err) {
        if (err) { console.error(err); return; }
        // get the manifest
        click.getFile("control.tar.gz", "./manifest", function(err, data) {
            if (err) { console.error(err); return; }
            var aa = [], manifest;
            try {
                manifest = JSON.parse(String.fromCharCode.apply(null, data));
            } catch(e) {
                console.error(e); return;
            }
            if (manifest.hooks) {
                for (var k in manifest.hooks) {
                    if (manifest.hooks[k].apparmor) {
                        aa.push(manifest.hooks[k].apparmor);
                    }
                }
            }
            if (aa.length > 0) {
                // read the first apparmor file
                click.getFile("data.tar.gz", "./" + aa[0], function(err, data) {
                    if (err) { console.error(err); return; }
                    var apparmor;
                    try {
                        apparmor = JSON.parse(String.fromCharCode.apply(null, data));
                    } catch(e) {
                        console.error(e); return;
                    }
                    if (apparmor.template && apparmor.template === "ubuntu-webapp") {
                        alert("Sorry, Marvin can't be used to usefully test webapps.");
                        input.value = "";
                    }
                });
            }
        });
    }
}

document.getElementsByName("click")[0].onchange = function(e) {
    if (this.files && this.files.length > 0) examine(this, this.files[0]);
};
</script>
{% endblock %}
